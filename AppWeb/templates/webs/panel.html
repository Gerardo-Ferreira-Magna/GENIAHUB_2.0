{% extends 'webs/base.html' %}
{% load static %}

{% block title %}GENIAHUB | Panel de Proyectos{% endblock %}

{% block content %}

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<!--<link rel="stylesheet" href="{% static 'css/estilo_panel.css' %}">-->

<style>
      .resumen-mini-card {
      transition: .3s ease;
  }

  .resumen-mini-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 3px 12px rgba(0,0,0,0.15);
  }

  /* Animación suave */
  .card-animate {
      opacity: 0;
      transform: translateY(15px);
      transition: opacity .6s ease, transform .6s ease;
  }

  /* Cuando se activa */
  .card-animate.show {
      opacity: 1;
      transform: translateY(0);
  }

</style>

<div class="container-fluid px-4 py-4">

    <!-- ENCABEZADO -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <h2 class="fw-bold section-title mb-2 text-primary">
            <i class="bi bi-kanban me-2"></i>Panel de Proyectos
        </h2>

        <a href="{% url 'creacion_proyecto' %}" class="btn btn-primary rounded-pill px-4">
            <i class="bi bi-plus-circle me-2"></i>Nuevo Proyecto
        </a>
    </div>

    <!-- TARJETAS RESUMEN -->

    <div class="row g-3 resumen-cards mb-4">

        <div class="col-6 col-md-2">
          <div class="card resumen-mini-card p-3 d-flex flex-column justify-content-between">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0 text-muted">Total</h6>
              <i class="bi bi-kanban text-primary fs-5"></i>
            </div>
            <h2 class="fw-semibold mt-2 mb-0">{{ total_proyectos }}</h2>
          </div>
        </div>

        <div class="col-6 col-md-2">
          <div class="card resumen-mini-card p-3 d-flex flex-column justify-content-between">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0 text-muted">Activos</h6>
              <i class="bi bi-lightning-charge text-success fs-5"></i>
            </div>
            <h2 class="fw-semibold mt-2 mb-0">{{ activos }}</h2>
          </div>
        </div>

        <div class="col-6 col-md-2">
          <div class="card resumen-mini-card p-3 d-flex flex-column justify-content-between">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0 text-muted">En Revisión</h6>
              <i class="bi bi-search text-info fs-5"></i>
            </div>
            <h2 class="fw-semibold mt-2 mb-0">{{ revision }}</h2>
          </div>
        </div>

        <div class="col-6 col-md-2">
          <div class="card resumen-mini-card p-3 d-flex flex-column justify-content-between">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0 text-muted">Aprobados</h6>
              <i class="bi bi-check2-circle text-success fs-5"></i>
            </div>
            <h2 class="fw-semibold mt-2 mb-0">{{ aprobados }}</h2>
          </div>
        </div>

        <div class="col-6 col-md-2">
          <div class="card resumen-mini-card p-3 d-flex flex-column justify-content-between">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0 text-muted">Finalizados</h6>
              <i class="bi bi-flag-fill text-secondary fs-5"></i>
            </div>
            <h2 class="fw-semibold mt-2 mb-0">{{ finalizados }}</h2>
          </div>
        </div>

        <div class="col-6 col-md-2">
          <div class="card resumen-mini-card p-3 d-flex flex-column justify-content-between">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0 text-muted">Detenidos</h6>
              <i class="bi bi-pause-circle text-warning fs-5"></i>
            </div>
            <h2 class="fw-semibold mt-2 mb-0">{{ detenidos }}</h2>
          </div>
        </div>

    </div>


    <!-- FILTROS AVANZADOS -->
    <div class="card p-3 mb-4 shadow-sm">

        <div class="row g-3">

            <div class="col-md-4">
                <label class="form-label fw-semibold">Buscar texto</label>
                <input id="searchInput" type="text" class="form-control" placeholder="Buscar por título o autor...">
            </div>

            <div class="col-md-3">
                <label class="form-label fw-semibold">Estado</label>
                <select id="filterEstado" class="form-select">
                    <option value="">Todos</option>
                    <option value="BOR">Borrador</option>
                    <option value="REV">En Revisión</option>
                    <option value="ACT">Activo</option>
                    <option value="APR">Aprobado</option>
                    <option value="DET">Detenido</option>
                    <option value="FIN">Finalizado</option>
                    <option value="PUB">Publicado</option>
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label fw-semibold">Desde</label>
                <input id="fechaDesde" type="date" class="form-control">
            </div>

            <div class="col-md-2">
                <label class="form-label fw-semibold">Hasta</label>
                <input id="fechaHasta" type="date" class="form-control">
            </div>

        </div>
    </div>

    <!-- TABLA -->
    <div class="card p-3 mb-5 shadow-sm">

        <div class="table-responsive">
            <table class="table table-hover align-middle" id="projectsTable">
                <thead class="table-dark">
                    <tr>
                        <th class="text-warning">#</th>
                        <th class="text-warning">Proyecto</th>
                        <th class="text-warning">Líder Proyecto</th>
                        <th class="text-warning">Estado</th>
                        <th class="text-warning">Progreso</th>
                        <th class="text-warning">Creación</th>
                        <th class="text-warning">Última actualización</th>
                        <th class="text-warning">Acciones</th>
                    </tr>
                </thead>

                <tbody>
                    {% for p in proyectos %}
                    <tr class="fila-proyecto"
                        data-estado="{{ p.estado }}"
                        data-fecha="{{ p.created_at|date:'Y-m-d' }}"
                    >

                        <td>{{ forloop.counter|stringformat:"02d" }}</td>
                        <td>{{ p.titulo }}</td>

                        <td>{{ p.autor.nombre }} {{ p.autor.apellido_paterno }}</td>

                        <!-- ESTADO -->
                        <td>
                            {% if p.estado == "ACT" %}
                                <span class="badge bg-primary">Activo</span>
                            {% elif p.estado == "APR" %}
                                <span class="badge bg-success">Aprobado</span>
                            {% elif p.estado == "REV" %}
                                <span class="badge bg-info text-dark">En revisión</span>
                            {% elif p.estado == "DET" %}
                                <span class="badge bg-warning text-dark">Detenido</span>
                            {% elif p.estado == "FIN" %}
                                <span class="badge bg-secondary">Finalizado</span>
                            {% else %}
                                <span class="badge bg-dark">Borrador</span>
                            {% endif %}
                        </td>

                        <!-- PROGRESO AUTOMÁTICO -->
                        <td>
                            <div class="progress progress-xs">
                                <div class="progress-bar 
                                  {% if p.estado == 'ACT' %} bg-primary w-50
                                  {% elif p.estado == 'REV' %} bg-info text-dark w-25
                                  {% elif p.estado == 'APR' %} bg-success w-75
                                  {% elif p.estado == 'FIN' %} bg-secondary w-100
                                  {% elif p.estado == 'DET' %} bg-warning text-dark w-10
                                  {% else %} bg-dark w-5
                                  {% endif %}">
                                </div>
                            </div>
                        </td>

                        <td>{{ p.created_at|date:"d M Y" }}</td>
                        <td>{{ p.updated_at|date:"d M Y" }}</td>

                        <td>
                            <button class="btn btn-sm btn-outline-primary btn-ver"
                                data-titulo="{{ p.titulo }}"
                                data-autor="{{ p.autor.nombre }} {{ p.autor.apellido_paterno }}"
                                data-estado="{{ p.get_estado_display }}"
                                data-resumen="{{ p.resumen }}"
                                data-descripcion="{{ p.descripcion }}">
                                <i class="bi bi-eye"></i>
                            </button>

                            <button class="btn btn-sm btn-outline-secondary btn-editar"
                                data-id="{{ p.id }}"
                                data-titulo="{{ p.titulo }}"
                                data-estado="{{ p.estado }}"
                                data-resumen="{{ p.resumen }}"
                                data-descripcion="{{ p.descripcion }}">
                                <i class="bi bi-pencil"></i>
                            </button>

                            <button class="btn btn-sm btn-outline-danger btn-eliminar"
                                data-id="{{ p.id }}"
                                data-titulo="{{ p.titulo }}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>

                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- PAGINACIÓN -->
        <ul class="pagination pagination-sm justify-content-end mt-3" id="pagination"></ul>
    </div>

</div>

<!-- ============================= -->
<!--           MODALES             -->
<!-- ============================= -->

<!-- MODAL DETALLE -->
<div class="modal fade" id="modalDetalle" tabindex="-1">
  <div class="modal-dialog modal-lg"><div class="modal-content">

      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Detalle del Proyecto</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <h4 id="detalleTitulo"></h4>
        <p><strong>Autor:</strong> <span id="detalleAutor"></span></p>
        <p><strong>Estado:</strong> <span id="detalleEstado"></span></p>
        <p><strong>Resumen:</strong></p>
        <p id="detalleResumen"></p>

        <hr>

        <p><strong>Descripción:</strong></p>
        <p id="detalleDescripcion"></p>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>

  </div></div>
</div>

<!-- MODAL EDITAR -->
<div class="modal fade" id="modalEditar" tabindex="-1">
  <div class="modal-dialog modal-lg"><div class="modal-content">

      <div class="modal-header bg-warning">
        <h5 class="modal-title">Editar Proyecto</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <form id="formEditar" method="POST">
          {% csrf_token %}

          <input type="hidden" name="proyecto_id" id="editId">

          <label class="form-label fw-semibold">Título</label>
          <input id="editTitulo" name="titulo" class="form-control">

          <label class="form-label fw-semibold mt-3">Estado</label>
          <select id="editEstado" name="estado" class="form-select">
            <option value="BOR">Borrador</option>
            <option value="REV">En revisión</option>
            <option value="APR">Aprobado</option>
            <option value="ACT">En ejecución</option>
            <option value="DET">Detenido</option>
            <option value="FIN">Finalizado</option>
            <option value="PUB">Publicado</option>
          </select>

          <label class="form-label fw-semibold mt-3">Resumen</label>
          <textarea id="editResumen" name="resumen" class="form-control" rows="3"></textarea>

          <label class="form-label fw-semibold mt-3">Descripción</label>
          <textarea id="editDescripcion" name="descripcion" class="form-control" rows="5"></textarea>

          <button class="btn btn-primary mt-3 w-100">Guardar Cambios</button>
        </form>

      </div>

  </div></div>
</div>

<!-- MODAL ELIMINAR -->
<div class="modal fade" id="modalEliminar" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">

      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Eliminar Proyecto</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body text-center">
        <p>¿Estás seguro que deseas eliminar:</p>
        <h5 id="eliminarTitulo" class="text-danger fw-bold"></h5>

        <form id="formEliminar" method="POST">
          {% csrf_token %}
          <input type="hidden" name="proyecto_id" id="deleteId">
          <button class="btn btn-danger w-100 mt-3">Sí, eliminar</button>
        </form>
      </div>

  </div></div>
</div>

<!-- Toasts -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:99999;"></div>

<!-- VARIABLES PARA JS -->
<script>
    window.CSRF_TOKEN   = "{{ csrf_token }}";
    window.URL_EDITAR   = "{% url 'proyecto_editar_modal' %}";
    window.URL_ELIMINAR = "{% url 'proyecto_eliminar_modal' %}";
</script>

<script>
    // ANIMACIÓN SOLO PARA LAS TARJETAS DEL PANEL
  document.addEventListener("DOMContentLoaded", () => {
      const cards = document.querySelectorAll(".resumen-mini-card");

      cards.forEach((card, index) => {
          // agregar la clase base
          card.classList.add("card-animate");

          // delay en cadena (tipo Stagger animación)
          setTimeout(() => {
              card.classList.add("show");
          }, 150 * index);  // 150 ms por tarjeta
      });
  });

</script>


<!-- JS externo -->
<script src="{% static 'js/panel_proyectos.js' %}"></script>

{% endblock %}









