{% extends "webs/base.html" %}
{% load static %}

{% block title %}Asistente IA | GENIAHUB{% endblock %}

{% block content %}

<style>
    .ia-sidebar { max-width: 280px; min-width: 260px; background: #f8f9fa; border-right: 1px solid #e1e1e1; height: calc(100vh - 120px); overflow-y: auto; }
    .ia-chat-area { display: flex; flex-direction: column; height: calc(100vh - 120px); }
    .ia-message { padding: 12px 16px; border-radius: 12px; max-width: 75%; margin-bottom: 10px; width: fit-content; }
    .msg-ai { background-color: #e9efff; margin-right: auto; }
    .msg-user { background-color: #1754cf; color: white; margin-left: auto; }
    .ia-controls button { margin-right: 6px; }
</style>

<div class="container-fluid">

    <!-- TITULO -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold text-primary">
            <i class="bi bi-robot"></i> Asistente de Planificaci√≥n de Proyectos
        </h2>
        <span class="badge bg-success">IA ACTIVA</span>
    </div>

    <div class="row">

        <!-- COLUMNA IZQUIERDA ‚Äì PROYECTOS -->
        <div class="col-md-3 ia-sidebar p-3">
            <h5 class="fw-bold mb-3">üìå Proyectos solicitados</h5>

            <!-- FILTRO -->
            <form method="get">
                <input type="text" name="buscar" class="form-control mb-2"
                       placeholder="Buscar proyecto..."
                       value="{{ buscar }}">
            </form>

            {% if proyectos %}
                <ul class="list-group">
                    {% for p in proyectos %}
                        <li class="list-group-item list-group-item-action proyecto-item"
                            data-titulo="{{ p.titulo }}"
                            data-resumen="{{ p.resumen }}"
                            data-palabras="{{ p.palabras_clave }}">
                            <strong>{{ p.titulo }}</strong><br>
                            <small class="text-muted">{{ p.get_estado_display }}</small>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">A√∫n no hay solicitudes.</p>
            {% endif %}
        </div>

        <!-- COLUMNA DERECHA ‚Äì CHAT IA -->
        <div class="col-md-9 ia-chat-area">

            <div id="iaMessages" class="flex-grow-1 p-3 mb-2 border rounded bg-white" style="overflow-y:auto;">
                <div class="ia-message msg-ai">üëã Hola, selecciona un proyecto o cu√©ntame algo.</div>
            </div>

            <div class="ia-controls mb-3 text-end">
                <button class="btn btn-outline-primary btn-sm ia-btn" data-msg="Sugerir equipo ideal para este proyecto.">Sugerir equipo ideal</button>
                <button class="btn btn-outline-warning btn-sm ia-btn" data-msg="Analiza viabilidad t√©cnica y econ√≥mica.">Evaluar viabilidad</button>
                <button class="btn btn-outline-info btn-sm ia-btn" data-msg="Crear planificaci√≥n por semanas.">Planificaci√≥n estimada</button>
            </div>

            <form id="iaForm" class="d-flex">
                {% csrf_token %}
                <input id="iaInput" type="text" class="form-control" placeholder="Escribe tu mensaje...">
                <button class="btn btn-primary ms-2"><i class="bi bi-send"></i></button>
            </form>
        </div>
    </div>
</div>

<!-- SCRIPTS IA -->
<script>
function agregarMensaje(texto, tipo){
    let box = document.createElement("div");
    box.classList.add("ia-message", tipo === "user" ? "msg-user" : "msg-ai");
    box.innerText = texto;
    document.getElementById("iaMessages").appendChild(box);
    document.getElementById("iaMessages").scrollTop = document.getElementById("iaMessages").scrollHeight;
}

// CLICK EN PROYECTO ‚Üí IA LO LEE AUTOM√ÅTICAMENTE
document.querySelectorAll(".proyecto-item").forEach(item => {
    item.addEventListener("click", function(){
        const msg = `
        Analiza este proyecto y sugiere mejoras:
        T√≠tulo: ${this.dataset.titulo}
        Resumen: ${this.dataset.resumen}
        Palabras clave: ${this.dataset.palabras}
        `;
        agregarMensaje(msg, "user");
        enviarIA(msg);
    });
});

// BOTONES PREDEFINIDOS
document.querySelectorAll(".ia-btn").forEach(btn => {
    btn.addEventListener("click", function(){
        document.getElementById("iaInput").value = this.dataset.msg;
        document.getElementById("iaForm").dispatchEvent(new Event("submit"));
    });
});

// ENV√çO DEL CHAT
document.getElementById("iaForm").addEventListener("submit", function(e){
    e.preventDefault();
    let text = document.getElementById("iaInput").value.trim();
    if(text !== ""){
        agregarMensaje(text, "user");
        enviarIA(text);
        document.getElementById("iaInput").value = "";
    }
});

async function enviarIA(text){
    let res = await fetch("{% url 'asistente_ia_api' %}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mensaje: text })
    });
    let data = await res.json();
    agregarMensaje(data.respuesta || "‚ö† Error en IA", "ai");
}
</script>
{% endblock %}







