{% extends "webs/base.html" %}
{% load static %}

{% block title %}Asistente IA | GENIAHUB{% endblock %}

{% block content %}

<style>
    /* --- Sidebar de proyectos --- */
    .ia-sidebar {
        max-width: 280px;
        min-width: 260px;
        background: #f8f9fa;
        border-right: 1px solid #e1e1e1;
        height: calc(100vh - 120px);
        overflow-y: auto;
    }

    .proyecto-item {
        cursor: pointer;
        margin-bottom: 10px;      /* separaci√≥n entre proyectos */
        border-radius: 12px;
        transition: 0.2s ease;
    }

    .proyecto-item:hover {
        box-shadow: 0px 4px 10px rgba(0,0,0,0.15);
        transform: translateY(-3px);
        background-color: #ffffff !important;
    }

    /* --- √Årea del chat --- */
    .ia-chat-area {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 180px);  /* Chat m√°s corto */
    }

    /* Mensajes */
    #iaMessages {
        overflow-y: auto;
        max-height: 62vh;
        padding: 1rem;
    }

    .ia-message {
        padding: 10px 14px;
        border-radius: 12px;
        max-width: 75%;
        margin-bottom: 8px;
        width: fit-content;
        font-size: 0.92rem;
    }

    .msg-ai {
        background-color: #eef3ff;
        margin-right: auto;
        border-left: 4px solid #4d8bf2;
    }

    .msg-user {
        background-color: #1754cf;
        color: white;
        margin-left: auto;
    }

    /* Loader estilo mensaje IA */
    .msg-thinking {
        background: #eef3ff;
        margin-right: auto;
        border-left: 4px solid #4d8bf2;
        font-style: italic;
        opacity: 0.9;
    }
</style>

<div class="container-fluid">

    <!-- TITULO -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold text-primary">
            <i class="bi bi-robot"></i> Asistente de Planificaci√≥n de Proyectos
        </h2>
        <span class="badge bg-success">IA ACTIVA</span>
    </div>

    <div class="row">

        <!-- COLUMNA IZQUIERDA ‚Äì PROYECTOS -->
        <div class="col-md-3 ia-sidebar p-3">
            <h5 class="fw-bold mb-3">üìå Proyectos solicitados</h5>

            <!-- FILTRO -->
            <form method="get">
                <input type="text" name="buscar" class="form-control mb-2"
                    placeholder="Buscar proyecto..."
                    value="{{ buscar }}">
            </form>

            {% if proyectos %}
                <ul class="list-group">
                    {% for p in proyectos %}
                        <li class="list-group-item proyecto-item"
                            data-titulo="{{ p.titulo }}"
                            data-resumen="{{ p.resumen }}"
                            data-palabras="{{ p.palabras_clave }}">
                            <strong>{{ p.titulo }}</strong><br>
                            <small class="text-muted">{{ p.get_estado_display }}</small>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">A√∫n no hay solicitudes.</p>
            {% endif %}
        </div>

        <!-- COLUMNA DERECHA ‚Äì CHAT -->
        <div class="col-md-9 ia-chat-area">

            <!-- CONTROLES ARRIBA DEL CHAT -->
            <div class="ia-controls mb-2 p-2 rounded bg-light border d-flex justify-content-between align-items-center">
                <div>
                    <button class="btn btn-outline-primary btn-sm ia-btn" data-msg="Sugerir equipo ideal para este proyecto.">Equipo ideal</button>
                    <button class="btn btn-outline-warning btn-sm ia-btn" data-msg="Analiza viabilidad t√©cnica y econ√≥mica.">Viabilidad</button>
                    <button class="btn btn-outline-info btn-sm ia-btn" data-msg="Crear planificaci√≥n por semanas.">Planificaci√≥n</button>
                </div>
                <div>
                    <button id="btnClear" class="btn btn-danger btn-sm"><i class="bi bi-trash"></i></button>
                    <button id="btnSave" class="btn btn-success btn-sm"><i class="bi bi-download"></i></button>
                </div>
            </div>

            <!-- AREA DE MENSAJES -->
            <div id="iaMessages" class="border rounded bg-white">
                <div class="ia-message msg-ai">üëã Hola, selecciona un proyecto o cu√©ntame algo.</div>
            </div>

            <!-- FORMULARIO ENV√çO MENSAJE -->
            <form id="iaForm" class="d-flex mt-2">
                {% csrf_token %}
                <input id="iaInput" type="text" class="form-control" placeholder="Escribe tu mensaje...">
                <button class="btn btn-primary ms-2"><i class="bi bi-send"></i></button>
            </form>
        </div>
    </div>
</div>

<script>
function agregarMensaje(texto, tipo){
    let box = document.createElement("div");
    box.classList.add("ia-message", tipo === "user" ? "msg-user" : "msg-ai");
    box.innerText = texto;
    document.getElementById("iaMessages").appendChild(box);
    document.getElementById("iaMessages").scrollTop =
        document.getElementById("iaMessages").scrollHeight;
}

// --- CLICK EN PROYECTO ---
document.querySelectorAll(".proyecto-item").forEach(item => {
    item.addEventListener("click", function(){
        const msg = `
        Analiza este proyecto y sugiere mejoras:
        T√≠tulo: ${this.dataset.titulo}
        Resumen: ${this.dataset.resumen}
        Palabras clave: ${this.dataset.palabras}
        `;
        agregarMensaje(msg, "user");
        enviarIA(msg);
    });
});

// --- BOTONES SUGERENCIAS ---
document.querySelectorAll(".ia-btn").forEach(btn => {
    btn.addEventListener("click", function(){
        document.getElementById("iaInput").value = this.dataset.msg;
        document.getElementById("iaForm").dispatchEvent(new Event("submit"));
    });
});

// --- BOT√ìN LIMPIAR CHAT ---
document.getElementById("btnClear").addEventListener("click", function() {
    document.getElementById("iaMessages").innerHTML =
        '<div class="ia-message msg-ai">üßπ Chat limpiado. ¬øEn qu√© puedo ayudarte ahora?</div>';
});

// --- GUARDAR CHAT COMO TXT ---
document.getElementById("btnSave").addEventListener("click", function() {
    let mensajes = document.getElementById("iaMessages").innerText;
    let blob = new Blob([mensajes], { type: "text/plain" });
    let link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "chat_geniahub.txt";
    link.click();
});

// --- üëâ NUEVO: LOADER ESTILO WHATSAPP EN EL CHAT ---
async function enviarIA(text){
    // Mensaje "Pensando" tipo IA
    const thinkingBox = document.createElement("div");
    thinkingBox.classList.add("ia-message", "msg-thinking");
    thinkingBox.innerText = "‚Ä¢‚Ä¢‚Ä¢ pensando...";
    thinkingBox.id = "thinkingMessage";
    document.getElementById("iaMessages").appendChild(thinkingBox);

    let res = await fetch("{% url 'asistente_ia_api' %}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mensaje: text })
    });

    let data = await res.json();

    // Eliminar loader
    document.getElementById("thinkingMessage").remove();

    agregarMensaje(data.respuesta || "‚ö† Error en IA", "ai");
}
</script>

{% endblock %}









