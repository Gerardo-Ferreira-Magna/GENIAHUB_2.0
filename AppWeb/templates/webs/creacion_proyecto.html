{% extends "webs/base.html" %}

{% block title %}Crear Proyecto | GENIAHUB{% endblock %}

{% block content %}

<div class="container mt-4">

    <h2 class="fw-bold mb-4">
        <i class="bi bi-folder-plus text-primary"></i>
        Crear Nuevo Proyecto
    </h2>

    <form action="" method="POST" enctype="multipart/form-data" class="card shadow-sm p-4">
        {% csrf_token %}

        <!-- ===============================
             INFORMACIÓN GENERAL
        ================================ -->
        <h5 class="fw-bold mb-3 text-primary">Información General</h5>

        <div class="row g-3">

            <!-- ✅ CREADO POR (NUEVO) -->
            <div class="col-12">
                <p class="text-muted mb-1">
                    <strong>Creado por:</strong>
                    {{ request.user.nombre }} {{ request.user.apellido_paterno }}
                    (<span class="text-primary">{{ request.user.email }}</span>)
                </p>
            </div>

            <div class="col-12">
                <label class="form-label fw-semibold">Título del Proyecto</label>
                {{ form.titulo }}
            </div>

            <div class="col-md-4">
                <label class="form-label fw-semibold">Tipo de Proyecto</label>
                {{ form.tipo }}
            </div>

            <div class="col-md-4">
                <label class="form-label fw-semibold">Fecha del Proyecto</label>
                {{ form.fecha_proyecto }}
            </div>

            <div class="col-md-4">
                <label class="form-label fw-semibold">Estado</label>
                {{ form.estado }}
            </div>

            <!-- RESUMEN EJECUTIVO -->
            <div class="col-12">
                <label class="form-label fw-semibold">Resumen Ejecutivo</label>
                {{ form.resumen }}
                <div class="d-flex justify-content-between mt-1">
                    <small class="text-muted">Máx. 700 caracteres</small>
                    <small class="text-secondary" id="countResumen">0 / 700</small>
                </div>

                <!-- Botón IA -->
                <button type="button" class="btn btn-outline-primary btn-sm mt-2"
                        data-bs-toggle="modal" data-bs-target="#modalIA"
                        onclick="setIAField('resumen')">
                    <i class="bi bi-stars me-1"></i> Generar con IA
                </button>
            </div>

            <!-- DESCRIPCIÓN COMPLETA -->
            <div class="col-12">
                <label class="form-label fw-semibold">Descripción Completa</label>
                {{ form.descripcion }}
                <div class="d-flex justify-content-between mt-1">
                    <small class="text-muted">Máx. 1500 caracteres</small>
                    <small class="text-secondary" id="countDescripcion">0 / 1500</small>
                </div>

                <!-- Botón IA -->
                <button type="button" class="btn btn-outline-primary btn-sm mt-2"
                        data-bs-toggle="modal" data-bs-target="#modalIA"
                        onclick="setIAField('descripcion')">
                    <i class="bi bi-magic me-1"></i> Generar con IA
                </button>
            </div>

        </div>

        <hr class="my-4">

        <!-- ===============================
             DATOS ADICIONALES
        ================================ -->
        <h5 class="fw-bold mb-3 text-primary">Datos Adicionales</h5>

        <div class="row g-3">

            <div class="col-md-6">
                <label class="form-label fw-semibold">Carrera</label>
                {{ form.carrera }}
            </div>

            <!-- ✅ SEDE AUTOMÁTICA (TEXTO + CAMPO OCULTO) -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Sede</label>
                <input type="text"
                       class="form-control"
                       value="{{ request.user.sede.nombre|default:'Sin sede asignada' }}"
                       disabled>
                <!-- mantenemos el campo del form oculto para que viaje al backend -->
                <div class="d-none">
                    {{ form.sede }}
                </div>
            </div>

            <div class="col-12">
                <label class="form-label fw-semibold">Palabras clave</label>
                {{ form.palabras_clave }}
            </div>

            <div class="col-12">
                <label class="form-label fw-semibold">Documento PDF</label>
                {{ form.documento_pdf }}
            </div>

        </div>

        <hr class="my-4">

        <!-- ===============================
             VISIBILIDAD
        ================================ -->
        <h5 class="fw-bold mb-3 text-primary">Visibilidad</h5>

        <div class="form-check form-switch">
            {{ form.es_publico }}
            <label class="form-check-label fw-semibold">
                Proyecto público
            </label>
        </div>

        <!-- ===============================
             BOTONES
        ================================ -->
        <div class="d-flex justify-content-end mt-4">
            <a href="{% url 'proyectos' %}" class="btn btn-outline-secondary me-2">
                Cancelar
            </a>

            <button type="submit" class="btn btn-primary px-4">
                <i class="bi bi-check-circle"></i>
                Crear Proyecto
            </button>
        </div>

    </form>

</div>

<!-- ===============================
     MODAL IA
=============================== -->
<div class="modal fade" id="modalIA" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-robot me-2"></i>Asistente IA</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p class="mb-2 text-muted">Se generará texto basado en el título del proyecto.</p>

        <button class="btn btn-primary w-100" onclick="generarIA()">
            <i class="bi bi-stars me-1"></i> Generar contenido
        </button>

        <div id="iaLoading" class="text-center mt-3 d-none">
          <div class="spinner-border"></div>
          <p class="text-muted mt-2">Generando…</p>
        </div>

      </div>
    </div>
  </div>
</div>

{% endblock %}

<!-- ===============================
     SCRIPT JS
=============================== -->
<script>
let iaField = null;

function setIAField(field) {
    iaField = field;
}

function generarIA() {
    const titulo = document.querySelector("#id_titulo").value.trim();
    if (!titulo) {
        alert("Primero escribe un título.");
        return;
    }

    document.getElementById("iaLoading").classList.remove("d-none");

    fetch("/api/generar_texto_ia/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ titulo })
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById("iaLoading").classList.add("d-none");

        if (iaField === "resumen" && data.resumen) {
            document.querySelector("#id_resumen").value = data.resumen;
        } else if (iaField === "descripcion" && data.descripcion) {
            document.querySelector("#id_descripcion").value = data.descripcion;
        }

        contarCaracteres();
        bootstrap.Modal.getInstance(document.getElementById("modalIA")).hide();
    })
    .catch(err => {
        document.getElementById("iaLoading").classList.add("d-none");
        alert("Error al generar texto.");
        console.error(err);
    });
}

// Contadores
function contarCaracteres() {
    const r = document.querySelector("#id_resumen");
    const d = document.querySelector("#id_descripcion");

    if (r) document.querySelector("#countResumen").textContent = `${r.value.length} / 700`;
    if (d) document.querySelector("#countDescripcion").textContent = `${d.value.length} / 1500`;
}

document.addEventListener("DOMContentLoaded", () => {
    contarCaracteres();
    document.addEventListener("input", contarCaracteres);
});
</script>


