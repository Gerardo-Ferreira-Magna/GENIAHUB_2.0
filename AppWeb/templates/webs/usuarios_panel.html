{% extends 'webs/base.html' %}
{% load static %}
{% block title %}GENIAHUB | Usuarios{% endblock %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/estilo_panel.css' %}">

<!-- ✅ Contenedor de Toasts (mismo estilo que ya usas) -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

<div class="container-fluid px-4 py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold text-primary"><i class="bi bi-people me-2 text-primary"></i> Usuarios</h2>
    <div>
      <a href="{% url admin_user_add_url %}" class="btn btn-primary">
        <i class="bi bi-person-plus me-1"></i> Nuevo usuario
      </a>
    </div>
  </div>

  <!-- FILTROS (UNA SOLA FILA, EN VIVO) -->
  <div class="card border-0 shadow-sm mb-3 p-3 bg-white">
    <div class="row g-2 align-items-center">
      <div class="col-md-3">
        <input id="f_q" type="text" class="form-control" placeholder="Nombre / Apellidos" value="{{ request.GET.q|default:'' }}">
      </div>
      <div class="col-md-2">
        <input id="f_rut" type="text" class="form-control" placeholder="RUT" value="{{ request.GET.rut|default:'' }}">
      </div>
      <div class="col-md-2">
        <input id="f_email" type="text" class="form-control" placeholder="Correo" value="{{ request.GET.email|default:'' }}">
      </div>
      <div class="col-md-1">
        <select id="f_rol" class="form-select">
          <option value="">Rol</option>
          <option value="EST" {% if request.GET.rol == 'EST' %}selected{% endif %}>Estudiante</option>
          <option value="DOC" {% if request.GET.rol == 'DOC' %}selected{% endif %}>Docente</option>
          <option value="EMP" {% if request.GET.rol == 'EMP' %}selected{% endif %}>Empresa</option>
          <option value="ADM" {% if request.GET.rol == 'ADM' %}selected{% endif %}>Administrador</option>
        </select>
      </div>
      <div class="col-md-1">
        <select id="f_activo" class="form-select">
          <option value="">Activo</option>
          <option value="1" {% if request.GET.activo == '1' %}selected{% endif %}>Sí</option>
          <option value="0" {% if request.GET.activo == '0' %}selected{% endif %}>No</option>
        </select>
      </div>
      <div class="col-md-1">
        <select id="f_staff" class="form-select">
          <option value="">Staff</option>
          <option value="1" {% if request.GET.staff == '1' %}selected{% endif %}>Sí</option>
          <option value="0" {% if request.GET.staff == '0' %}selected{% endif %}>No</option>
        </select>
      </div>
      <div class="col-md-2 text-end">
        <button id="clearFilters" class="btn btn-outline-secondary">Limpiar</button>
      </div>
    </div>
  </div>

  <!-- TABLA -->
  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table id="tblUsuarios" class="table align-middle">
          <thead class="table-secondary">
            <tr>
              <th>Nombre</th>
              <th>RUT</th>
              <th>Correo</th>
              <th>Rol</th>
              <th>Activo</th>
              <th>Staff</th>
              <th class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for u in page_obj %}
            {% if not u.is_superuser %}
            <tr id="row-{{ u.id }}" data-id="{{ u.id }}">
              <td>
                <strong class="cell-nombre">{{ u.nombre }} {{ u.apellido_paterno }} {{ u.apellido_materno }}</strong>
                <div class="small text-muted">{{ u.date_joined|date:"d-m-Y H:i" }}</div>
              </td>
              <td class="cell-rut">{{ u.rut }}</td>
              <td class="cell-email"><a href="mailto:{{ u.email }}">{{ u.email }}</a></td>
              <td class="cell-rol">
                <span class="badge
                  {% if u.rol == 'ADM' %} bg-dark
                  {% elif u.rol == 'DOC' %} bg-primary
                  {% elif u.rol == 'EMP' %} bg-warning text-dark
                  {% else %} bg-success {% endif %}">
                  {{ u.get_rol_display }}
                </span>
              </td>
              <td class="cell-activo">
                {% if u.is_active %}<span class="badge bg-warning text-dark">Sí</span>{% else %}<span class="badge bg-secondary">No</span>{% endif %}
              </td>
              <td class="cell-staff">
                {% if u.is_staff %}<span class="badge bg-warning text-dark">Sí</span>{% else %}<span class="badge bg-secondary">No</span>{% endif %}
              </td>
              <td class="text-end">
                <div class="btn-group">
                  <button class="btn btn-sm btn-outline-primary btn-edit" data-id="{{ u.id }}">
                    <i class="bi bi-pencil-square"></i> Editar
                  </button>
                  <button class="btn btn-sm btn-outline-danger btn-delete" data-id="{{ u.id }}">
                    <i class="bi bi-trash3"></i> Eliminar
                  </button>
                </div>
              </td>
            </tr>
            {% endif %}
            {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted py-5">
                <i class="bi bi-inbox me-2"></i>No hay usuarios.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- paginación -->
      <div class="mt-3 d-flex justify-content-end">
        {% if page_obj.has_previous %}
          <a class="btn btn-sm btn-outline-secondary me-2" href="?page={{ page_obj.previous_page_number }}">Anterior</a>
        {% endif %}
        <span class="align-self-center">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
          <a class="btn btn-sm btn-outline-secondary ms-2" href="?page={{ page_obj.next_page_number }}">Siguiente</a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- MODAL EDICIÓN -->
<div class="modal fade" id="modalUsuario" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Editar usuario</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formUsuario">
          <!-- no uso form csrf directo; el token se toma de la cookie -->
          <input type="hidden" name="id" id="u_id">
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label small">Nombre</label>
              <input class="form-control" name="nombre" id="u_nombre">
            </div>
            <div class="col-md-4">
              <label class="form-label small">Apellido Paterno</label>
              <input class="form-control" name="apellido_paterno" id="u_apellido_paterno">
            </div>
            <div class="col-md-4">
              <label class="form-label small">Apellido Materno</label>
              <input class="form-control" name="apellido_materno" id="u_apellido_materno">
            </div>

            <div class="col-md-4">
              <label class="form-label small">RUT</label>
              <input class="form-control" name="rut" id="u_rut">
            </div>
            <div class="col-md-4">
              <label class="form-label small">Email</label>
              <input class="form-control" name="email" id="u_email" type="email">
            </div>
            <div class="col-md-4">
              <label class="form-label small">Rol</label>
              <select class="form-select" name="rol" id="u_rol">
                <option value="EST">Estudiante</option>
                <option value="DOC">Docente</option>
                <option value="EMP">Empresa</option>
                <option value="ADM">Administrador</option>
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label small">Activo</label>
              <select class="form-select" name="is_active" id="u_is_active">
                <option value="1">Sí</option>
                <option value="0">No</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label small">Staff</label>
              <select class="form-select" name="is_staff" id="u_is_staff">
                <option value="1">Sí</option>
                <option value="0">No</option>
              </select>
            </div>

            <!-- PASSWORD: siempre vacío; si se completa, se actualiza -->
            <div class="col-md-6">
              <label class="form-label small">Contraseña (dejar vacío para no cambiar)</label>
              <input class="form-control" name="password" id="u_password" type="password" autocomplete="new-password">
            </div>
            <div class="col-md-6">
              <label class="form-label small">Confirmar Contraseña</label>
              <input class="form-control" name="password_confirm" id="u_password_confirm" type="password" autocomplete="new-password">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="saveUsuario" class="btn btn-primary">Guardar cambios</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL ELIMINAR -->
<div class="modal fade" id="modalEliminar" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Confirmar eliminación</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="eliminarTexto">¿Confirma eliminar este usuario?</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="confirmEliminar" class="btn btn-danger">Eliminar</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
function getCookie(name) {
  const v = `; ${document.cookie}`;
  const p = v.split(`; ${name}=`);
  if (p.length === 2) return decodeURIComponent(p.pop().split(';').shift());
  return null;
}
const CSRF = getCookie('csrftoken');

function showToast(message, type = 'primary') {
  const container = document.querySelector('.toast-container');
  const icon = type === 'success' ? 'bi-check-circle-fill'
             : type === 'danger' ? 'bi-exclamation-triangle-fill'
             : type === 'warning' ? 'bi-exclamation-circle' : 'bi-info-circle';
  const bg = type === 'success' ? 'bg-success'
           : type === 'danger' ? 'bg-danger'
           : type === 'warning' ? 'bg-warning text-dark' : 'bg-primary';
  const toast = document.createElement('div');
  toast.className = `toast align-items-center text-white border-0 mb-2 ${bg}`;
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body"><i class="bi ${icon} me-2"></i>${message}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>`;
  container.appendChild(toast);
  const t = new bootstrap.Toast(toast, { delay: 4000 });
  t.show(); toast.addEventListener('hidden.bs.toast', () => toast.remove());
}

/* === Filtros locales === */
function debounce(fn, ms = 250){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
function applyFilters(){
  const q=document.getElementById('f_q').value.toLowerCase(),
        rut=document.getElementById('f_rut').value.toLowerCase(),
        email=document.getElementById('f_email').value.toLowerCase(),
        rol=document.getElementById('f_rol').value,
        activo=document.getElementById('f_activo').value,
        staff=document.getElementById('f_staff').value;
  document.querySelectorAll('#tblUsuarios tbody tr').forEach(tr=>{
    const txt=(s)=>tr.querySelector(s)?.textContent.toLowerCase()||'';
    const ok=(!q||txt('.cell-nombre').includes(q))&&(!rut||txt('.cell-rut').includes(rut))
      &&(!email||txt('.cell-email').includes(email))&&(!rol||txt('.cell-rol').includes(rol.toLowerCase()))
      &&(!activo||txt('.cell-activo').includes(activo==='1'?'sí':'no'))
      &&(!staff||txt('.cell-staff').includes(staff==='1'?'sí':'no'));
    tr.style.display=ok?'':'none';
  });
}
['f_q','f_rut','f_email','f_rol','f_activo','f_staff']
  .forEach(id=>document.getElementById(id).addEventListener('input',debounce(applyFilters,200)));
document.getElementById('clearFilters').addEventListener('click',()=>{
  ['f_q','f_rut','f_email','f_rol','f_activo','f_staff'].forEach(i=>document.getElementById(i).value='');
  applyFilters(); showToast('Filtros limpiados','success');
});

/* === Modales === */
const modalEdit=new bootstrap.Modal('#modalUsuario');
const modalDel=new bootstrap.Modal('#modalEliminar');
let editingId=null,deletingId=null;

/* === Editar === */
document.querySelectorAll('.btn-edit').forEach(b=>{
  b.onclick=async e=>{
    const id=e.currentTarget.dataset.id; editingId=id;
    const r=await fetch(`/api/usuario/${id}/`, { credentials:'same-origin' });
    const d=await r.json();
    if(!d.ok) return showToast(d.error||'Error al obtener usuario','danger');
    const u=d.usuario;
    for(const k of ['id','nombre','apellido_paterno','apellido_materno','rut','email']) 
      document.getElementById('u_'+k).value=u[k]||'';
    document.getElementById('u_rol').value=u.rol;
    document.getElementById('u_is_active').value=u.is_active?'1':'0';
    document.getElementById('u_is_staff').value=u.is_staff?'1':'0';
    document.getElementById('u_password').value='';
    document.getElementById('u_password_confirm').value='';
    modalEdit.show();
  };
});

/* === Guardar === */
document.getElementById('saveUsuario').onclick=async()=>{
  const id=editingId||document.getElementById('u_id').value;
  const p={
    nombre:u_nombre.value.trim(),
    apellido_paterno:u_apellido_paterno.value.trim(),
    apellido_materno:u_apellido_materno.value.trim(),
    rut:u_rut.value.trim(),
    email:u_email.value.trim(),
    rol:u_rol.value,
    is_active:u_is_active.value==='1',
    is_staff:u_is_staff.value==='1',
    password:u_password.value,
    password_confirm:u_password_confirm.value
  };
  if(p.password&&p.password!==p.password_confirm)
    return showToast('Las contraseñas no coinciden','warning');
  const r=await fetch(`/api/usuario/${id}/update/`,{
    method:'POST',
    headers:{'Content-Type':'application/json','X-CSRFToken':CSRF},
    credentials:'same-origin',
    body:JSON.stringify(p)
  });
  const d=await r.json();
  if(!d.ok) return showToast(d.error||'Error al actualizar','danger');
  showToast('Usuario actualizado','success');
  modalEdit.hide();

  // 🔄 Actualización directa en la fila
  const row=document.getElementById(`row-${id}`);
  if(row){
    row.querySelector('.cell-nombre').textContent=`${p.nombre} ${p.apellido_paterno} ${p.apellido_materno}`;
    row.querySelector('.cell-rut').textContent=p.rut;
    row.querySelector('.cell-email').innerHTML=`<a href="mailto:${p.email}">${p.email}</a>`;
    const rolMap={ADM:'bg-dark',DOC:'bg-primary',EMP:'bg-warning text-dark',EST:'bg-success'};
    const rolLabel={ADM:'Administrador',DOC:'Docente',EMP:'Empresa',EST:'Estudiante'}[p.rol]||p.rol;
    row.querySelector('.cell-rol').innerHTML=`<span class="badge ${rolMap[p.rol]||'bg-secondary'}">${rolLabel}</span>`;
    row.querySelector('.cell-activo').innerHTML=p.is_active?'<span class="badge bg-success">Sí</span>':'<span class="badge bg-secondary">No</span>';
    row.querySelector('.cell-staff').innerHTML=p.is_staff?'<span class="badge bg-info text-dark">Sí</span>':'<span class="badge bg-secondary">No</span>';
  }
};

/* === Eliminar === */
document.querySelectorAll('.btn-delete').forEach(b=>{
  b.onclick=e=>{
    deletingId=e.currentTarget.dataset.id;
    eliminarTexto.textContent=`¿Confirma eliminar al usuario #${deletingId}?`;
    modalDel.show();
  };
});
document.getElementById('confirmEliminar').onclick=async()=>{
  if(!deletingId)return;
  const r=await fetch(`/api/usuario/${deletingId}/delete/`,{
    method:'POST',
    headers:{'X-CSRFToken':CSRF},
    credentials:'same-origin'
  });
  const d=await r.json();
  if(!d.ok)return showToast(d.error||'Error al eliminar','danger');
  modalDel.hide();
  document.getElementById(`row-${deletingId}`)?.remove();
  showToast('Usuario eliminado','success');
};
});
</script>

{% endblock %}



