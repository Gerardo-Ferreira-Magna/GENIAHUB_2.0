{% extends 'webs/base.html' %}
{% load static %}
{% block title %}GENIAHUB | Usuarios{% endblock %}
{% block content %}

<!-- Fuente y estilos -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/estilo_panel_usuarios.css' %}">

<!-- Toasts -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:9999;"></div>

<div class="container-fluid panel-container">

  <!-- Encabezado -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h3 class="fw-bold mb-0 text-primary">
      <i class="bi bi-people me-2"></i> Gesti√≥n de Usuarios
    </h3>
    <button class="btn btn-primary rounded-pill" data-bs-toggle="modal" data-bs-target="#modalNuevoUsuario">
      <i class="bi bi-person-plus me-1"></i> Nuevo Usuario
    </button>
  </div>

  <!-- TARJETAS -->
  <div class="row g-3 resumen-cards mb-4">
    <div class="col-6 col-md-2">
      <div class="card resumen-mini-card p-3 d-flex flex-column justify-content-between">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0 text-muted">Total</h6>
          <i class="bi bi-people text-primary fs-5"></i>
        </div>
        <h2 class="fw-semibold mt-2 mb-0">{{ total_usuarios }}</h2>
      </div>
    </div>

    <div class="col-6 col-md-2">
      <div class="card resumen-mini-card p-3 d-flex flex-column justify-content-between">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0 text-muted">Activos</h6>
          <i class="bi bi-person-check text-success fs-5"></i>
        </div>
        <h2 class="fw-semibold mt-2 mb-0">{{ activos }}</h2>
      </div>
    </div>

    <div class="col-6 col-md-2">
      <div class="card resumen-mini-card p-3 d-flex flex-column justify-content-between">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0 text-muted">Inactivos</h6>
          <i class="bi bi-person-x text-danger fs-5"></i>
        </div>
        <h2 class="fw-semibold mt-2 mb-0">{{ inactivos }}</h2>
      </div>
    </div>

    <div class="col-6 col-md-2">
      <div class="card resumen-mini-card p-3 d-flex flex-column justify-content-between">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0 text-muted">Docentes</h6>
          <i class="bi bi-person-badge text-info fs-5"></i>
        </div>
        <h2 class="fw-semibold mt-2 mb-0">{{ docentes }}</h2>
      </div>
    </div>

    <div class="col-6 col-md-2">
      <div class="card resumen-mini-card p-3 d-flex flex-column justify-content-between">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0 text-muted">Estudiantes</h6>
          <i class="bi bi-mortarboard text-warning fs-5"></i>
        </div>
        <h2 class="fw-semibold mt-2 mb-0">{{ estudiantes }}</h2>
      </div>
    </div>

    <div class="col-6 col-md-2">
      <div class="card resumen-mini-card p-3 d-flex flex-column justify-content-between">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0 text-muted">Empresas</h6>
          <i class="bi bi-building text-secondary fs-5"></i>
        </div>
        <h2 class="fw-semibold mt-2 mb-0">{{ empresas }}</h2>
      </div>
    </div>
  </div>

  <!-- FILTROS -->
  <div class="card border-0 shadow-sm mb-3 p-3 bg-white">
    <div class="row g-2 align-items-center">
      <div class="col-md-3"><input id="f_q" type="text" class="form-control" placeholder="Nombre / Apellidos"></div>
      <div class="col-md-2"><input id="f_rut" type="text" class="form-control" placeholder="RUT"></div>
      <div class="col-md-2"><input id="f_email" type="text" class="form-control" placeholder="Correo"></div>
      <div class="col-md-1">
        <select id="f_rol" class="form-select">
          <option value="">Rol</option>
          <option value="EST">Estudiante</option>
          <option value="DOC">Docente</option>
          <option value="EMP">Empresa</option>
          <option value="ADM">Administrador</option>
        </select>
      </div>
      <div class="col-md-1">
        <select id="f_activo" class="form-select">
          <option value="">Activo</option>
          <option value="1">S√≠</option>
          <option value="0">No</option>
        </select>
      </div>
      <div class="col-md-1">
        <select id="f_staff" class="form-select">
          <option value="">Staff</option>
          <option value="1">S√≠</option>
          <option value="0">No</option>
        </select>
      </div>
      <div class="col-md-2 text-end">
        <button id="clearFilters" class="btn btn-outline-secondary">Limpiar</button>
      </div>
    </div>
  </div>

  <!-- TABLA -->
  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table id="tblUsuarios" class="table align-middle table-hover mb-0">
          <thead class="table-dark">
            <tr>
              <th>Nombre</th>
              <th>RUT</th>
              <th>Correo</th>
              <th>Rol</th>
              <th>Activo</th>
              <th>Staff</th>
              <th class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for u in page_obj %}
              {% if not u.is_superuser %}
              <tr id="row-{{ u.id }}" data-id="{{ u.id }}">
                <td><strong>{{ u.nombre }} {{ u.apellido_paterno }}</strong></td>
                <td>{{ u.rut }}</td>
                <td><a href="mailto:{{ u.email }}">{{ u.email }}</a></td>
                <td>
                  <span class="badge
                    {% if u.rol == 'ADM' %}bg-dark
                    {% elif u.rol == 'DOC' %}bg-primary
                    {% elif u.rol == 'EMP' %}bg-warning text-dark
                    {% else %}bg-success{% endif %}">
                    {{ u.get_rol_display }}
                  </span>
                </td>
                <td>{% if u.is_active %}<span class="badge bg-success">S√≠</span>{% else %}<span class="badge bg-secondary">No</span>{% endif %}</td>
                <td>{% if u.is_staff %}<span class="badge bg-info text-dark">S√≠</span>{% else %}<span class="badge bg-secondary">No</span>{% endif %}</td>
                <td class="text-end">
                  <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary btn-edit" data-id="{{ u.id }}">
                      <i class="bi bi-pencil-square"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger btn-delete" data-id="{{ u.id }}">
                      <i class="bi bi-trash3"></i>
                    </button>
                  </div>
                </td>
              </tr>
              {% endif %}
            {% empty %}
              <tr><td colspan="7" class="text-center text-muted py-5">No hay usuarios registrados.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- MODAL NUEVO USUARIO -->
<div class="modal fade" id="modalNuevoUsuario" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Nuevo Usuario</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formNuevoUsuario">
          <div class="row g-2">
            <div class="col-md-4"><label class="form-label small">Nombre</label><input name="nombre" class="form-control"></div>
            <div class="col-md-4"><label class="form-label small">Apellido Paterno</label><input name="apellido_paterno" class="form-control"></div>
            <div class="col-md-4"><label class="form-label small">Apellido Materno</label><input name="apellido_materno" class="form-control"></div>
            <div class="col-md-4"><label class="form-label small">RUT</label><input name="rut" class="form-control"></div>
            <div class="col-md-4"><label class="form-label small">Email</label><input name="email" class="form-control" type="email"></div>
            <div class="col-md-4">
              <label class="form-label small">Rol</label>
              <select name="rol" class="form-select">
                <option value="EST">Estudiante</option>
                <option value="DOC">Docente</option>
                <option value="EMP">Empresa</option>
                <option value="ADM">Administrador</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label small">Activo</label>
              <select name="is_active" class="form-select"><option value="1">S√≠</option><option value="0">No</option></select>
            </div>
            <div class="col-md-3">
              <label class="form-label small">Staff</label>
              <select name="is_staff" class="form-select"><option value="1">S√≠</option><option value="0">No</option></select>
            </div>
            <div class="col-md-6"><label class="form-label small">Contrase√±a</label><input name="password" type="password" class="form-control"></div>
            <div class="col-md-6"><label class="form-label small">Confirmar Contrase√±a</label><input name="password_confirm" type="password" class="form-control"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="btnCrearUsuario" class="btn btn-primary">Crear Usuario</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL EDITAR USUARIO -->
<div class="modal fade" id="modalUsuario" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Editar usuario</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formUsuario">
          <input type="hidden" id="u_id" name="id">
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label small">Nombre</label>
              <input class="form-control" id="u_nombre" name="nombre">
            </div>
            <div class="col-md-4">
              <label class="form-label small">Apellido Paterno</label>
              <input class="form-control" id="u_apellido_paterno" name="apellido_paterno">
            </div>
            <div class="col-md-4">
              <label class="form-label small">Apellido Materno</label>
              <input class="form-control" id="u_apellido_materno" name="apellido_materno">
            </div>

            <div class="col-md-4">
              <label class="form-label small">RUT</label>
              <input class="form-control" id="u_rut" name="rut">
            </div>
            <div class="col-md-4">
              <label class="form-label small">Email</label>
              <input class="form-control" id="u_email" name="email" type="email">
            </div>
            <div class="col-md-4">
              <label class="form-label small">Rol</label>
              <select class="form-select" id="u_rol" name="rol">
                <option value="EST">Estudiante</option>
                <option value="DOC">Docente</option>
                <option value="EMP">Empresa</option>
                <option value="ADM">Administrador</option>
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label small">Activo</label>
              <select class="form-select" id="u_is_active" name="is_active">
                <option value="1">S√≠</option>
                <option value="0">No</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label small">Staff</label>
              <select class="form-select" id="u_is_staff" name="is_staff">
                <option value="1">S√≠</option>
                <option value="0">No</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label small">Contrase√±a (dejar vac√≠o para no cambiar)</label>
              <input class="form-control" id="u_password" name="password" type="password" autocomplete="new-password">
            </div>
            <div class="col-md-6">
              <label class="form-label small">Confirmar Contrase√±a</label>
              <input class="form-control" id="u_password_confirm" name="password_confirm" type="password" autocomplete="new-password">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="saveUsuario" class="btn btn-primary">
          <i class="bi bi-save me-1"></i> Guardar cambios
        </button>
      </div>
    </div>
  </div>
</div>


<!-- MODAL EDITAR -->
<div class="modal fade" id="modalEditarUsuario" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Editar Usuario</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formEditarUsuario">
          <div class="row g-2">
            <div class="col-md-6"><label class="form-label small">Nombre</label><input id="edit_nombre" name="nombre" class="form-control"></div>
            <div class="col-md-6"><label class="form-label small">Correo</label><input id="edit_email" name="email" class="form-control"></div>
            <div class="col-md-6"><label class="form-label small">RUT</label><input id="edit_rut" name="rut" class="form-control"></div>
            <div class="col-md-6"><label class="form-label small">Rol</label>
              <select id="edit_rol" name="rol" class="form-select">
                <option value="EST">Estudiante</option>
                <option value="DOC">Docente</option>
                <option value="EMP">Empresa</option>
                <option value="ADM">Administrador</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="btnGuardarCambios" class="btn btn-info text-white">Guardar Cambios</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL ELIMINAR -->
<div class="modal fade" id="modalEliminarUsuario" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Eliminar Usuario</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>¬øDeseas eliminar este usuario?</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="confirmEliminarUsuario" class="btn btn-danger">Eliminar</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL CONFIRMAR ELIMINACI√ìN -->
<div class="modal fade" id="modalConfirmDelete" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="bi bi-trash3-fill me-2"></i>Confirmar eliminaci√≥n</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <p>¬øEst√°s seguro de que deseas eliminar este usuario?</p>
        <p class="text-muted small mb-0">Esta acci√≥n no se puede deshacer.</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="confirmDelete" class="btn btn-danger">Eliminar</button>
      </div>
    </div>
  </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", function () {
  // === util: leer CSRF ===
  const CSRF = document.cookie.split('csrftoken=')[1]?.split(';')[0];

  // === toasts (ya lo tienes; si no, pega tu showToast aqu√≠) ===
  function showToast(message, type = 'primary') {
    const container = document.querySelector('.toast-container');
    const icon = {
      success: 'bi-check-circle-fill',
      danger: 'bi-exclamation-triangle-fill',
      warning: 'bi-exclamation-circle',
      info: 'bi-info-circle'
    }[type] || 'bi-info-circle';

    const bg = {
      success: 'bg-success',
      danger: 'bg-danger',
      warning: 'bg-warning text-dark',
      info: 'bg-info text-dark',
      primary: 'bg-primary'
    }[type] || 'bg-primary';

    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white border-0 mb-2 ${bg}`;
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body"><i class="bi ${icon} me-2"></i>${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>`;
    container.appendChild(toast);
    new bootstrap.Toast(toast, { delay: 3500 }).show();
    toast.addEventListener('hidden.bs.toast', () => toast.remove());
  }

  // === Abrir modal y rellenar datos ===
  document.querySelectorAll('.btn-edit').forEach(btn => {
    btn.onclick = async (e) => {
      const id = e.currentTarget.dataset.id;
      try {
        const r = await fetch(`/api/usuario/${id}/`, { credentials: 'same-origin' });
        const d = await r.json();
        if (!d.ok) return showToast(d.error || 'No se pudo obtener el usuario', 'danger');

        const u = d.usuario;
        // Rellenar
        document.getElementById('u_id').value = u.id;
        document.getElementById('u_nombre').value = u.nombre || '';
        document.getElementById('u_apellido_paterno').value = u.apellido_paterno || '';
        document.getElementById('u_apellido_materno').value = u.apellido_materno || '';
        document.getElementById('u_rut').value = u.rut || '';
        document.getElementById('u_email').value = u.email || '';
        document.getElementById('u_rol').value = u.rol || 'EST';
        document.getElementById('u_is_active').value = u.is_active ? '1' : '0';
        document.getElementById('u_is_staff').value = u.is_staff ? '1' : '0';
        document.getElementById('u_password').value = '';
        document.getElementById('u_password_confirm').value = '';

        new bootstrap.Modal('#modalUsuario').show();
      } catch (err) {
        console.error(err);
        showToast('Error al conectar con el servidor', 'danger');
      }
    };
  });

  // === Guardar cambios ===
  document.getElementById('saveUsuario')?.addEventListener('click', async () => {
    const id = document.getElementById('u_id').value;
    const form = document.getElementById('formUsuario');
    const data = Object.fromEntries(new FormData(form).entries());

    // Normalizar booleanos
    data.is_active = data.is_active === '1';
    data.is_staff = data.is_staff === '1';

    // Validaci√≥n r√°pida de password
    if ((data.password || data.password_confirm) && data.password !== data.password_confirm) {
      return showToast('Las contrase√±as no coinciden', 'warning');
    }

    try {
      const r = await fetch(`/api/usuario/${id}/update/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
        credentials: 'same-origin',
        body: JSON.stringify(data)
      });
      const res = await r.json();
      if (!res.ok) return showToast(res.error || 'Error al actualizar', 'danger');

      showToast('‚úèÔ∏è Usuario actualizado correctamente', 'success');
      bootstrap.Modal.getInstance(document.getElementById('modalUsuario')).hide();
      setTimeout(() => location.reload(), 1000);
    } catch (err) {
      console.error(err);
      showToast('Error al conectar con el servidor', 'danger');
    }
  });
});
</script>

<script>
// ==== ELIMINAR USUARIO (con modal de confirmaci√≥n) ====
let usuarioIdEliminar = null;
document.querySelectorAll('.btn-delete').forEach(btn => {
  btn.addEventListener('click', (e) => {
    usuarioIdEliminar = e.currentTarget.dataset.id;

    // Mostrar nombre din√°mico en el modal
    const fila = document.querySelector(`#row-${usuarioIdEliminar}`);
    const nombre = fila ? fila.querySelector('td strong')?.textContent.trim() : '';
    document.getElementById('deleteMsg').innerHTML =
      `¬øDeseas eliminar al usuario <strong>${nombre}</strong>?`;

    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('modalConfirmDelete'));
    modal.show();
  });
});

// Confirmar eliminaci√≥n
document.getElementById('confirmDelete')?.addEventListener('click', async () => {
  if (!usuarioIdEliminar) return;
  try {
    const r = await fetch(`/api/usuario/${usuarioIdEliminar}/delete/`, {
      method: "POST",
      headers: { "X-CSRFToken": CSRF },
    });
    const res = await r.json();

    bootstrap.Modal.getInstance(document.getElementById('modalConfirmDelete')).hide();

    if (!res.ok) {
      showToast(res.error || "Error al eliminar usuario", "danger");
      return;
    }

    showToast("üóëÔ∏è Usuario eliminado correctamente", "success");
    setTimeout(() => location.reload(), 800);
  } catch (error) {
    console.error(error);
    showToast("‚ùå Error al conectar con el servidor", "danger");
  }
});
</script>



{% endblock %}






