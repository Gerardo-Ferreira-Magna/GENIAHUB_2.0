{% extends 'webs/base.html' %}


{% block content %}

<!-- Fuente Google -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>

/* ======== FUENTE GLOBAL ======== */
body, table, .form-control, .btn, .badge, .toast, h3, label {
  font-family: 'Inter', sans-serif !important;
}

/* ======== AJUSTE DE LAYOUT ======== */
.main-container .content {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.dashboard-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 0;
}

/* ======== CONTENEDOR PRINCIPAL ======== */
.panel-container {
  flex: 1;
  width: 100%;
  padding: 2rem;
  display: flex;
  flex-direction: column;
}

/* ======== TABLA ======== */
/* Forzar color personalizado para .table-dark */
.table-dark {
  background-color: #212429 !important;
  color: #fff !important;
}

/* Para eliminar márgenes laterales fijos */
@media (min-width: 992px) {
  .panel-container {
    padding-left: 2rem;
    padding-right: 2rem;
  }
}
</style>

<div class="container-fluid panel-container">

  <!-- Encabezado -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h3 class="fw-bold mb-0 text-primary">
      <i class="bi bi-buildings me-2"></i> Solicitud de Empresas
    </h3>
  </div>

  <!-- TARJETAS RESUMEN -->
  <div class="row g-3 resumen-cards mb-4">
    <div class="col-6 col-md-3">
      <div class="card card-total p-3">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6>Total</h6>
            <h3>{{ total }}</h3>
          </div>
          <i class="bi bi-building text-primary"></i>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card card-aprobadas p-3">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6>Aprobadas</h6>
            <h3>{{ aprobadas }}</h3>
          </div>
          <i class="bi bi-check-circle text-success"></i>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card card-pendientes p-3">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6>Pendientes</h6>
            <h3>{{ pendientes }}</h3>
          </div>
          <i class="bi bi-hourglass-split text-warning"></i>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card card-rechazadas p-3">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6>Rechazadas</h6>
            <h3>{{ rechazadas }}</h3>
          </div>
          <i class="bi bi-x-circle text-danger"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="row g-3 align-items-end mb-4">
    <div class="col-md-4">
      <label class="form-label small fw-semibold">Buscar</label>
      <input type="text" id="filtroTexto" placeholder="Nombre, NIF/CIF o correo..." class="form-control" />
    </div>
    <div class="col-md-3">
      <label class="form-label small fw-semibold">Estado</label>
      <select id="filtroEstado" class="form-select">
        <option value="">Todos</option>
        <option value="PEN">Pendiente</option>
        <option value="APR">Aprobado</option>
        <option value="REJ">Rechazado</option>
      </select>
    </div>
  </div>

  <!-- Toasts flotantes -->
  <div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1100;">
    {% if messages %}
      {% for message in messages %}
        <div class="toast align-items-center text-white bg-{{ message.tags }} border-0 show mb-2 shadow">
          <div class="d-flex">
            <div class="toast-body fw-semibold">{{ message }}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
      {% endfor %}
    {% endif %}
  </div>

  <!-- Tabla -->
  {% if solicitudes %}
    <div class="table-responsive shadow-sm mt-3">
      <table id="tablaSolicitudes" class="table align-middle table-hover mb-0">
        <thead class="table-dark">
          <tr>
            <th class="text-warning">#</th>
            <th class="text-warning">Empresa</th>
            <th class="text-warning">NIF/CIF</th>
            <th class="text-warning">Correo</th>
            <th class="text-warning">Documento</th>
            <th class="text-warning">Estado</th>
            <th class="text-warning">Motivo</th>
            <th class="text-warning">Fecha</th>
            <th class="text-warning">Acción</th>
          </tr>
        </thead>
        <tbody>
          {% for s in solicitudes %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ s.nombre_empresa }}</td>
              <td>{{ s.nif_cif }}</td>
              <td>{{ s.email_tracking }}</td>

              <!-- DOCUMENTO -->
              <td class="text-center">
                {% if s.documento_adjunto and s.documento_adjunto.name %}
                  <a href="{{ s.documento_adjunto.url }}" class="btn btn-outline-secondary btn-sm" download title="Descargar documento">
                    <i class="bi bi-download"></i>
                  </a>
                {% endif %}
              </td>

              <!-- ESTADO -->
              <td data-estado="{{ s.estado }}">
                <span class="badge 
                  {% if s.estado == 'PEN' %}bg-warning text-dark
                  {% elif s.estado == 'APR' %}bg-success
                  {% elif s.estado == 'REJ' %}bg-danger
                  {% endif %}">
                  {{ s.get_estado_display }}
                </span>
              </td>

              <!-- MOTIVO -->
              <td>
                {% if s.estado == 'REJ' %}
                  <button class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modalMotivo{{ s.pk }}">
                    <i class="bi bi-chat-left-text"></i> Ver
                  </button>
                {% else %}
                  <span class="text-muted small">—</span>
                {% endif %}
              </td>

              <!-- FECHA -->
              <td>{{ s.created_at|date:"d-m-Y H:i" }}</td>

              <!-- ACCIÓN -->
              <td>
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-primary btn-sm rounded-pill" data-bs-toggle="modal" data-bs-target="#modalEditar{{ s.pk }}">
                    <i class="bi bi-pencil"></i>
                  </button>
                  {% if s.estado == 'PEN' %}
                    <a href="{% url 'cambiar_estado_solicitud' s.pk 'APR' %}" class="btn btn-outline-success btn-sm rounded-pill">Aprobar</a>
                    <a href="{% url 'cambiar_estado_solicitud' s.pk 'REJ' %}" class="btn btn-outline-danger btn-sm rounded-pill">Rechazar</a>
                  {% else %}
                    <span class="text-muted small mt-1">Sin acciones</span>
                  {% endif %}
                </div>
              </td>
            </tr>

            <!-- MODAL EDITAR -->
            <div class="modal fade" id="modalEditar{{ s.pk }}" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header bg-light">
                    <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Editar Solicitud</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <form method="POST" action="{% url 'editar_solicitud' s.pk %}">
                    {% csrf_token %}
                    <div class="modal-body">
                      <div class="mb-3">
                        <label class="form-label small fw-semibold">Nombre de la Empresa</label>
                        <input type="text" name="nombre_empresa" class="form-control" value="{{ s.nombre_empresa }}" required />
                      </div>
                      <div class="mb-3">
                        <label class="form-label small fw-semibold">NIF/CIF</label>
                        <input type="text" name="nif_cif" class="form-control" value="{{ s.nif_cif }}" required />
                      </div>
                      <div class="mb-3">
                        <label class="form-label small fw-semibold">Correo de Contacto</label>
                        <input type="email" name="correo_contacto" class="form-control" value="{{ s.email_tracking }}" required />
                      </div>
                      <div class="mb-3">
                        <label class="form-label small fw-semibold">Estado</label>
                        <select name="estado" class="form-select">
                          <option value="PEN" {% if s.estado == 'PEN' %}selected{% endif %}>Pendiente</option>
                          <option value="APR" {% if s.estado == 'APR' %}selected{% endif %}>Aprobado</option>
                          <option value="REJ" {% if s.estado == 'REJ' %}selected{% endif %}>Rechazado</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label class="form-label small fw-semibold">Motivo</label>
                        <textarea name="motivo_rechazo" rows="3" class="form-control">{{ s.motivo_rechazo }}</textarea>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                      <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- MODAL MOTIVO -->
            <div class="modal fade" id="modalMotivo{{ s.pk }}" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-danger">
                  <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Motivo de Rechazo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <p class="text-muted">{{ s.motivo_rechazo|default:"No especificado" }}</p>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-info text-center mt-4">No hay solicitudes registradas.</div>
  {% endif %}
</div>

<!-- JS -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll('.toast').forEach(t => new bootstrap.Toast(t, { delay: 3500 }).show());
});

const filtroTexto = document.getElementById("filtroTexto");
const filtroEstado = document.getElementById("filtroEstado");
const filas = document.querySelectorAll("#tablaSolicitudes tbody tr");

function filtrarTabla() {
  const texto = filtroTexto.value.toLowerCase().trim();
  const estadoSel = filtroEstado.value;

  filas.forEach(fila => {
    const columnas = fila.querySelectorAll("td");
    const empresa = columnas[1]?.innerText.toLowerCase() || "";
    const nif = columnas[2]?.innerText.toLowerCase() || "";
    const correo = columnas[3]?.innerText.toLowerCase() || "";
    const estado = fila.querySelector("td[data-estado]")?.getAttribute("data-estado") || "";

    const coincideTexto = empresa.includes(texto) || nif.includes(texto) || correo.includes(texto);
    const coincideEstado = !estadoSel || estado === estadoSel;

    fila.style.display = (coincideTexto && coincideEstado) ? "" : "none";
  });
}

filtroTexto.addEventListener("input", filtrarTabla);
filtroEstado.addEventListener("change", filtrarTabla);
</script>

{% endblock %}















