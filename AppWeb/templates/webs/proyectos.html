{% extends 'webs/base.html' %}
{% load static %}

{% block title %}GENIAHUB | Proyectos{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/estilo_proyecto.css' %}">

<!-- ‚úÖ BLOQUE DE MENSAJES -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
  {% if messages %}
    {% for message in messages %}
      <div class="toast align-items-center text-white border-0 mb-2 
        {% if message.tags == 'success' %}bg-success{% elif message.tags == 'error' or message.tags == 'danger' %}bg-danger{% elif message.tags == 'warning' %}bg-warning text-dark{% else %}bg-primary{% endif %}"
        role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">
            {% if message.tags == 'success' %}
              <i class="bi bi-check-circle-fill me-2"></i>
            {% elif message.tags == 'error' or message.tags == 'danger' %}
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
            {% elif message.tags == 'warning' %}
              <i class="bi bi-exclamation-circle me-2"></i>
            {% else %}
              <i class="bi bi-info-circle me-2"></i>
            {% endif %}
            {{ message }}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
        </div>
      </div>
    {% endfor %}
  {% endif %}
</div>

<!-- ‚úÖ Script para mostrar toasts -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const toastElList = [].slice.call(document.querySelectorAll('.toast'));
    toastElList.map(function(toastEl) {
      const toast = new bootstrap.Toast(toastEl, { delay: 4000 });
      toast.show();
    });
  });
</script>

<div class="container-fluid px-4 py-4">

  <!-- ENCABEZADO -->
  <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
    <h2 class="fw-bold section-title mb-2"><i class="bi bi-clipboard-check me-2 text-primary"></i>Proyectos</h2>
  </div>

  <!-- BUSCADOR CON LISTAS -->
  <div class="row mb-4 gy-2">
    <div class="col-md-4">
      <label class="form-label fw-semibold small text-secondary"><i class="bi bi-kanban me-2"></i>Proyecto</label>
      <select id="busquedaProyecto" class="form-select shadow-sm">
        <option value="all">Todos</option>
        {% for proyecto in proyectos %}
        <option value="{{ proyecto.nombre|lower }}">{{ proyecto.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label fw-semibold small text-secondary"><i class="bi bi-person-badge me-2"></i>Docente</label>
      <select id="busquedaDocente" class="form-select shadow-sm">
        <option value="all">Todos</option>
        {% for proyecto in proyectos|dictsort:"docente" %}
        <option value="{{ proyecto.docente|lower }}">{{ proyecto.docente }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label fw-semibold small text-secondary"><i class="bi bi-flag me-2"></i>Estado</label>
      <select id="busquedaEstado" class="form-select shadow-sm">
        <option value="all">Todos</option>
        <option value="en desarrollo">En Desarrollo</option>
        <option value="en proceso">En Proceso</option>
        <option value="finalizado">Finalizado</option>
      </select>
    </div>
  </div>

  <!-- BOT√ìN RESTABLECER -->
  <div class="text-end mb-3">
    <button id="resetFiltros" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-arrow-counterclockwise me-1"></i> Restablecer filtros
    </button>
  </div>

  <!-- FILTROS DE CATEGOR√çA -->
  <div class="mb-4">
    <h6 class="fw-semibold text-secondary mb-2"><i class="bi bi-tags me-2"></i>Categor√≠as</h6>
    <div class="d-flex flex-wrap gap-2 mb-3">
      <button class="btn btn-sm btn-outline-primary filter-btn active" data-filter="all">Todos</button>
      <button class="btn btn-sm btn-outline-primary filter-btn" data-filter="Inform√°tica">Inform√°tica</button>
      <button class="btn btn-sm btn-outline-primary filter-btn" data-filter="Mec√°nica">Mec√°nica</button>
      <button class="btn btn-sm btn-outline-primary filter-btn" data-filter="Tecnolog√≠a Aplicada">Tecnolog√≠a Aplicada</button>
      <button class="btn btn-sm btn-outline-primary filter-btn" data-filter="Log√≠stica">Log√≠stica</button>
      <button class="btn btn-sm btn-outline-primary filter-btn" data-filter="Energ√≠a">Energ√≠a</button>
      <button class="btn btn-sm btn-outline-primary filter-btn" data-filter="Administraci√≥n">Administraci√≥n</button>
      <button class="btn btn-sm btn-outline-primary filter-btn" data-filter="Educaci√≥n">Educaci√≥n</button>
    </div>
  </div>

  <div class="row g-4">
    <!-- GRID IZQUIERDO -->
    <div class="col-lg-8">
      <div id="gridProyectos" class="row row-cols-1 row-cols-md-2 g-4">
        {% for proyecto in proyectos %}
        <div class="col proyecto-item"
             data-categoria="{{ proyecto.categoria }}"
             data-estado="{{ proyecto.estado|lower }}"
             data-nombre="{{ proyecto.nombre|lower }}"
             data-docente="{{ proyecto.docente|lower }}">
          <div class="card project-card h-100 shadow-sm border-0 position-relative">
            <div class="favorite-icon position-absolute top-0 end-0 m-2">
              <i class="bi bi-heart fs-5 text-secondary fav-btn" data-id="{{ proyecto.id }}"></i>
            </div>
            <div class="project-img" style="background-image: url('{{ proyecto.imagen_url }}');">
              <div class="overlay">
                <button class="btn btn-sm btn-light me-2"><i class="bi bi-chat-text"></i> Postular</button>
                <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal"
                        data-bs-target="#modalProyecto{{ proyecto.id }}"><i class="bi bi-eye"></i> Ver</button>
              </div>
            </div>
            <div class="card-body">
              <h6 class="fw-bold mb-1">{{ proyecto.nombre }}</h6>
              <p class="text-muted small mb-2">Docente: <strong>{{ proyecto.docente }}</strong></p>
              <div class="d-flex justify-content-between align-items-center">
                <span class="badge bg-{{ proyecto.estado_color }}">
                  <i class="bi {{ proyecto.estado_icono }} me-1"></i>{{ proyecto.estado }}
                </span>
                <small class="text-muted">Modificado {{ proyecto.fecha_modificacion }}</small>
              </div>
            </div>
          </div>
        </div>

        <!-- MODAL DETALLE -->
        <div class="modal fade" id="modalProyecto{{ proyecto.id }}" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">{{ proyecto.nombre }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <img src="{{ proyecto.imagen_url }}" class="img-fluid rounded mb-3">
                <p>{{ proyecto.descripcion }}</p>
                <p><strong>Docente:</strong> {{ proyecto.docente }}</p>
                <p><strong>Categor√≠a:</strong> {{ proyecto.categoria }}</p>
                <p><strong>Estado:</strong> {{ proyecto.estado }}</p>
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline-primary">Postular</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- PANEL DERECHO -->
    <div class="col-lg-4">
      <div class="card p-3 mb-4 shadow-sm border-0">
        <h6 class="fw-bold mb-3"><i class="bi bi-robot me-2 text-primary"></i>Recomendaciones Inteligentes</h6>
        {% for rec in recomendaciones_ia %}
        <div class="d-flex align-items-start mb-3">
          <div class="icon-circle bg-light text-primary me-3">
            <i class="bi {{ rec.icono }}"></i>
          </div>
          <div>
            <strong>{{ rec.titulo }}</strong>
            <p class="small text-muted mb-1">{{ rec.descripcion }}</p>
            <button class="btn btn-sm btn-outline-primary rounded-pill btn-recomendar">
              <i class="bi bi-lightbulb me-1"></i>Obtener recomendaci√≥n
            </button>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- === CHATBOT FLOTANTE === -->
<div id="chatbot-ia" class="chatbot-container shadow-lg">
  <div id="chatbot-header" class="chatbot-header d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-2">
      <i class="bi bi-robot text-primary fs-5"></i>
      <strong>Asistente GENIA HUB</strong>
    </div>
    <button id="closeChat" class="btn btn-sm btn-light"><i class="bi bi-x"></i></button>
  </div>
  <div id="chatBox" class="chat-box mb-2"></div>
  <div class="input-group p-2">
    <input type="text" id="chatInput" class="form-control" placeholder="Escribe tu mensaje...">
    <button class="btn btn-primary" id="chatSend"><i class="bi bi-send"></i></button>
  </div>
</div>

<!-- Bot√≥n flotante -->
<button id="openChat" class="btn btn-primary rounded-circle shadow-lg">
  <i class="bi bi-chat-dots fs-5"></i>
</button>

<!-- Mensaje flotante del asistente -->
<div id="chatTooltip" class="chat-tooltip">üëã ¬°Estoy aqu√≠ para ayudarte!</div>

<!-- === SCRIPT FINAL === -->
<script>
/* === FAVORITOS === */
const favBtns = document.querySelectorAll('.fav-btn');
let favoritos = JSON.parse(localStorage.getItem('favoritos')) || [];

favBtns.forEach(btn => {
  const id = btn.dataset.id;
  if (favoritos.includes(id)) btn.classList.replace('bi-heart', 'bi-heart-fill');
  btn.addEventListener('click', () => {
    if (favoritos.includes(id)) {
      favoritos = favoritos.filter(f => f !== id);
      btn.classList.replace('bi-heart-fill', 'bi-heart');
    } else {
      favoritos.push(id);
      btn.classList.replace('bi-heart', 'bi-heart-fill');
    }
    localStorage.setItem('favoritos', JSON.stringify(favoritos));
  });
});

/* === FILTROS === */
const proyectos = document.querySelectorAll('.proyecto-item');
const selProyecto = document.getElementById('busquedaProyecto');
const selDocente = document.getElementById('busquedaDocente');
const selEstado = document.getElementById('busquedaEstado');
const filtroBtns = document.querySelectorAll('.filter-btn');

function aplicarBusqueda() {
  const p = selProyecto.value;
  const d = selDocente.value;
  const e = selEstado.value;

  proyectos.forEach(proj => {
    const matchP = (p === 'all' || proj.dataset.nombre === p);
    const matchD = (d === 'all' || proj.dataset.docente === d);
    const matchE = (e === 'all' || proj.dataset.estado === e);
    proj.style.display = (matchP && matchD && matchE) ? 'block' : 'none';
  });
}
[selProyecto, selDocente, selEstado].forEach(s => s.addEventListener('change', aplicarBusqueda));

/* === REESTABLECER FILTROS === */
const resetBtn = document.getElementById('resetFiltros');
resetBtn.addEventListener('click', () => {
  selProyecto.value = 'all';
  selDocente.value = 'all';
  selEstado.value = 'all';
  filtroBtns.forEach(b => b.classList.remove('active'));
  document.querySelector('.filter-btn[data-filter="all"]').classList.add('active');
  proyectos.forEach(p => p.style.display = 'block');
  resetBtn.classList.add('btn-success');
  resetBtn.innerHTML = '<i class="bi bi-check2-circle me-1"></i> Filtros restablecidos';
  setTimeout(() => {
    resetBtn.classList.replace('btn-success', 'btn-outline-secondary');
    resetBtn.innerHTML = '<i class="bi bi-arrow-counterclockwise me-1"></i> Restablecer filtros';
  }, 2000);
});

/* === CHATBOT Y TOOLTIP === */
const chatbot = document.getElementById('chatbot-ia');
const openChatBtn = document.getElementById('openChat');
const closeChatBtn = document.getElementById('closeChat');
const chatBox = document.getElementById('chatBox');
const chatInput = document.getElementById('chatInput');
const chatSend = document.getElementById('chatSend');
const tooltip = document.getElementById('chatTooltip');

const mensajes = [
  "üëã ¬°Estoy aqu√≠ para ayudarte!",
  "üí° Puedo recomendarte proyectos o docentes.",
  "ü§ñ Preg√∫ntame sobre tus intereses.",
];
let indice = 0;
let tooltipActivo = false;

function mostrarMensaje() {
  if (!tooltipActivo) return;
  tooltip.style.opacity = 1;
  tooltip.style.transform = "translateY(0)";
  tooltip.textContent = mensajes[indice];
  setTimeout(() => {
    tooltip.style.opacity = 0;
    tooltip.style.transform = "translateY(10px)";
    setTimeout(() => {
      indice = (indice + 1) % mensajes.length;
      if (tooltipActivo) mostrarMensaje();
    }, 1000);
  }, 4000);
}

function iniciarMensajes() {
  if (tooltipActivo) return;
  tooltipActivo = true;
  mostrarMensaje();
}
function detenerMensajes() {
  tooltipActivo = false;
  tooltip.style.opacity = 0;
  tooltip.style.transform = "translateY(10px)";
}

openChatBtn.addEventListener('click', () => {
  chatbot.style.display = 'flex';
  openChatBtn.style.display = 'none';
  detenerMensajes();
});

closeChatBtn.addEventListener('click', () => {
  chatbot.style.display = 'none';
  openChatBtn.style.display = 'flex';
  setTimeout(iniciarMensajes, 1500);
});

function addMessage(role, text) {
  const div = document.createElement('div');
  div.classList.add('chat-msg', role);
  div.textContent = text;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

chatSend.addEventListener('click', () => {
  const msg = chatInput.value.trim();
  if (!msg) return;
  addMessage('user', 'üßë‚Äçüíª ' + msg);
  chatInput.value = '';
  setTimeout(() => {
    addMessage('bot', 'ü§ñ Estoy aqu√≠ para asistirte con tus proyectos. Pronto me conectar√© al motor IA real.');
  }, 700);
});

/* === ANIMACI√ìN DE ENTRADA Y TOOLTIP === */
window.addEventListener('load', () => {
  // Mensaje tooltip
  setTimeout(iniciarMensajes, 2000);

  // Animaci√≥n de entrada de las cards (fade + slide)
  const cards = document.querySelectorAll('.project-card');
  cards.forEach((card, index) => {
    setTimeout(() => {
      card.classList.add('card-loaded');
    }, index * 250);
  });
});
</script>
{% endblock %}











