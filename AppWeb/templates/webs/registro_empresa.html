{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GENIAHUB | Registro Empresa</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
</head>
<body class="bg-light">
  <!-- NAVBAR -->
  <nav class="navbar navbar-light bg-white shadow-sm px-3">
    <div class="container-fluid">
      <div class="d-flex align-items-center">
        <a href="{% url 'index' %}" class="btn btn-outline-secondary btn-sm me-3">
          <i class="bi bi-arrow-left"></i> Volver al inicio
        </a>
        <a class="navbar-brand d-flex align-items-center" href="#">
          <i class="bi bi-kanban me-2 text-warning fs-4"></i>
          <span class="fw-semibold fs-5">GENIAHUB</span>
        </a>
      </div>
      <div>
        <span class="text-muted me-2">¬øYa tienes una cuenta?</span>
        <a href="{% url 'login' %}" class="btn btn-primary btn-sm">Iniciar Sesi√≥n</a>
      </div>
    </div>
  </nav>

  <!-- CONTENIDO PRINCIPAL -->
  <div class="container my-5">
    <div class="row g-5 align-items-start">
      <!-- IZQUIERDA -->
      <div class="col-lg-6">
        <h2 class="fw-bold mb-4">Conecta tu empresa con el<br><span class="text-primary">talento universitario del futuro.</span></h2>
        <p class="text-secondary mb-5">√önete a nuestra red de innovaci√≥n y encuentra los mejores proyectos y colaboradores para impulsar tu crecimiento.</p>

        <div class="alert alert-secondary small" role="alert">
          <strong>Pasos a seguir:</strong><br>
          1Ô∏è‚É£ Revisa que los datos est√©n correctos.<br>
          2Ô∏è‚É£ Acepta los T√©rminos y la Pol√≠tica.<br>
          3Ô∏è‚É£ Adjunta tu documento.<br>
          4Ô∏è‚É£ Env√≠a la solicitud.<br>
          5Ô∏è‚É£ Recibir√°s un correo con la confirmaci√≥n y siguientes instrucciones.
        </div>
      </div>

      <!-- DERECHA -->
      <div class="col-lg-6">
        <div class="card shadow-sm border-0">
          <div class="card-body p-4">
            <h5 class="fw-semibold mb-3"><i class="bi bi-buildings text-primary me-2"></i> Registro de Empresa</h5>

            <form id="registroForm" method="POST" enctype="multipart/form-data" action="#">
              {% csrf_token %}

              <div class="mb-3">
                <label class="form-label small fw-semibold">Nombre de la empresa</label>
                {{ form.nombre_empresa }}
              </div>

              <div class="mb-3">
                <label class="form-label small fw-semibold">Direcci√≥n fiscal</label>
                {{ form.direccion_fiscal }}
              </div>

              <div class="mb-4">
                <label class="form-label small fw-semibold">NIF/CIF de la Empresa</label>
                {{ form.nif_cif }}
              </div>

              <h5 class="fw-semibold mb-3"><i class="bi bi-person-lines-fill text-primary me-2"></i> Datos de Contacto</h5>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label small fw-semibold">N√∫mero de contacto</label>
                  {{ form.telefono_contacto }}
                </div>
                <div class="col-md-6 mb-4">
                  <label class="form-label small fw-semibold">Correo electr√≥nico corporativo</label>
                  {{ form.correo_contacto }}
                </div>
              </div>

              <!-- Checks -->
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="checkTerminosForm" />
                <label class="form-check-label small text-muted" for="checkTerminosForm">
                  He le√≠do y acepto los
                  <a href="#" data-bs-toggle="modal" data-bs-target="#modalTerminos" class="text-primary text-decoration-none">T√©rminos y Condiciones</a>.
                </label>
              </div>
              <div class="form-check mb-4">
                <input class="form-check-input" type="checkbox" id="checkPrivacidadForm" />
                <label class="form-check-label small text-muted" for="checkPrivacidadForm">
                  He le√≠do y acepto la
                  <a href="#" data-bs-toggle="modal" data-bs-target="#modalPrivacidad" class="text-primary text-decoration-none">Pol√≠tica de Privacidad</a>.
                </label>
              </div>

              <p class="text-muted small mb-3">
                Sube un documento que respalde tu solicitud (por ejemplo, una carta de presentaci√≥n o acreditaci√≥n de tu empresa).
              </p>
              <div class="mb-4">
                <label class="form-label small fw-semibold">Subir documento (PDF o Word)</label>
                {{ form.documento_adjunto }}
                <small class="text-muted">Tama√±o m√°ximo: 5 MB</small>
              </div>

              <div class="d-grid">
                <button type="submit" id="btnEnviar" class="btn btn-primary" disabled>Enviar Solicitud de Registro</button>
              </div>
            </form>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODALES DE ESTADO -->
  <div class="modal fade" id="modalEnviando" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4">
        <i class="bi bi-hourglass-split text-primary fs-1 mb-3"></i>
        <h5 class="mb-2">Procesando solicitud...</h5>
        <p class="text-muted small mb-0">Por favor espera un momento.</p>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalExito" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4">
        <i class="bi bi-check-circle-fill text-success fs-1 mb-3"></i>
        <h5 class="mb-2" id="tituloExito">Solicitud enviada correctamente</h5>
        <p class="text-muted small mb-0" id="textoExito">Tu registro est√° en proceso de revisi√≥n.</p>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalEnProceso" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4">
        <i class="bi bi-exclamation-triangle-fill text-warning fs-1 mb-3"></i>
        <h5 class="mb-2">Solicitud en proceso</h5>
        <p class="text-muted small mb-0" id="textoEnProceso">Ya existe una solicitud activa en revisi√≥n.</p>
      </div>
    </div>
  </div>

  <!-- MODALES INFO (t√©rminos/privacidad) -->
  <div class="modal fade" id="modalTerminos" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-file-earmark-text me-2"></i>T√©rminos y Condiciones</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body small text-muted">
          <p>Estos t√©rminos establecen las reglas de uso de la plataforma GENIAHUB...</p>
        </div>
        <div class="modal-footer">
          <div class="form-check me-auto">
            <input class="form-check-input" type="checkbox" id="checkTerminosModal" />
            <label class="form-check-label small" for="checkTerminosModal">He le√≠do y acepto los t√©rminos</label>
          </div>
          <button type="button" id="btnCerrarTerminos" class="btn btn-primary" data-bs-dismiss="modal" disabled>Aceptar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalPrivacidad" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-lock me-2"></i>Pol√≠tica de Privacidad</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body small text-muted">
          <p>GENIAHUB garantiza la confidencialidad de tus datos...</p>
        </div>
        <div class="modal-footer">
          <div class="form-check me-auto">
            <input class="form-check-input" type="checkbox" id="checkPrivacidadModal" />
            <label class="form-check-label small" for="checkPrivacidadModal">He le√≠do y acepto la pol√≠tica de privacidad</label>
          </div>
          <button type="button" id="btnCerrarPrivacidad" class="btn btn-primary" data-bs-dismiss="modal" disabled>Aceptar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // === UTILIDADES ===
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    function getCsrfToken() {
      const c = getCookie('csrftoken');
      if (c) return c;
      const el = document.querySelector('input[name="csrfmiddlewaretoken"]');
      return el ? el.value : '';
    }
    function getCorreo() {
      const el = document.querySelector('#id_correo_contacto, [name="correo_contacto"]');
      return el ? el.value.trim() : '';
    }
    function getNif() {
      const el = document.querySelector('#id_nif_cif, [name="nif_cif"]');
      return el ? el.value.trim() : '';
    }
    function getEmpresa() {
      const el = document.querySelector('#id_nombre_empresa, [name="nombre_empresa"]');
      return el ? el.value.trim() : '';
    }
    function getOrCreateModal(id) {
      const el = document.getElementById(id);
      if (!el) return null;
      let modal = bootstrap.Modal.getInstance(el);
      if (!modal) modal = new bootstrap.Modal(el);
      return modal;
    }
    function showModal(id, autocloseMs) {
      const modal = getOrCreateModal(id);
      if (!modal) return;
      modal.show();
      if (autocloseMs && autocloseMs > 0) setTimeout(() => modal.hide(), autocloseMs);
      return modal;
    }

    // === VALIDACI√ìN DE CHECKS ===
    const checkTerminosForm = document.getElementById("checkTerminosForm");
    const checkPrivacidadForm = document.getElementById("checkPrivacidadForm");
    const btnEnviar = document.getElementById("btnEnviar");
    function validarEnvio() {
      btnEnviar.disabled = !(checkTerminosForm.checked && checkPrivacidadForm.checked);
    }
    checkTerminosForm.addEventListener("change", validarEnvio);
    checkPrivacidadForm.addEventListener("change", validarEnvio);

    // === L√ìGICA PRINCIPAL ===
    const form = document.getElementById("registroForm");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const correo = getCorreo();
      const nif_cif = getNif();
      const empresa = getEmpresa();
      const csrftoken = getCsrfToken();

      const modalProc = getOrCreateModal("modalEnviando");
      modalProc.show();

      try {
        // üîç Verificar duplicados
        const respCheck = await fetch("{% url 'verificar_solicitud' %}", {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "X-CSRFToken": csrftoken,
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
          },
          body: new URLSearchParams({ correo, nif_cif })
        });

        if (!respCheck.ok) throw new Error(`Error ${respCheck.status}`);
        const data = await respCheck.json();
        setTimeout(() => modalProc.hide(), 300);

        if (data.exists_any) {
          const texto = document.getElementById("textoEnProceso");
          if (data.exists_email && data.exists_nif)
            texto.textContent = "Ya existe una solicitud activa para este correo y NIF/CIF.";
          else if (data.exists_email)
            texto.textContent = "Ya existe una solicitud activa para este correo.";
          else
            texto.textContent = "Ya existe una solicitud activa para este NIF/CIF.";
          showModal("modalEnProceso", 3500);
          return;
        }

        // üì® Env√≠o real
        const fd = new FormData(form);
        const respCreate = await fetch("{% url 'crear_solicitud' %}", {
          method: "POST",
          credentials: "same-origin",
          headers: { "X-CSRFToken": csrftoken },
          body: fd
        });

        setTimeout(() => modalProc.hide(), 300);

        if (!respCreate.ok) throw new Error(`Error ${respCreate.status}`);
        const dataCreate = await respCreate.json();

        if (dataCreate.ok) {
          const titulo = document.getElementById("tituloExito");
          const texto = document.getElementById("textoExito");
          titulo.textContent = `¬°Gracias, ${empresa || "tu empresa"}!`;
          texto.textContent = `Tu registro se envi√≥ correctamente. Te contactaremos en ${correo}.`;

          const modalExito = showModal("modalExito");
          setTimeout(() => {
            modalExito.hide();
            form.reset();
            checkTerminosForm.checked = false;
            checkPrivacidadForm.checked = false;
            btnEnviar.disabled = true;
          }, 3000);
        } else {
          alert("Errores en el formulario:\n" + JSON.stringify(dataCreate.errors, null, 2));
        }

      } catch (err) {
        console.error(err);
        modalProc.hide();
        alert("Ocurri√≥ un error al procesar la solicitud.");
      } finally {
        modalProc.hide();
      }
    });
  });
  </script>
</body>
</html>

















